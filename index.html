<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CDS-Cluster-Lite</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
      
  </head>
  <body id="Body">
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", SetupFhirConnection, false );
    
    let EunoChains = {};
    EunoChains.fhir = {};
    EunoChains.fhir.client = undefined;
    EunoChains.fhir.Patient = [];
    EunoChains.fhir.Condition = [];
    EunoChains.fhir.Observation = [];
    EunoChains.fhir.AllergyIntolerance = [];
    EunoChains.fhir.Procedure = [];
    EunoChains.fhir.MedicationStatement = [];
    EunoChains.ec = {};
    EunoChains.ec.results = [];
    EunoChains.artifact = {};
    
    
    let fhirConnectionEvent    = new Event("fhirConnection");
    document.addEventListener("fhirConnection", FetchFhirPatient, false );
    let fhirPatientEvent    = new Event("fhirPatient");
    document.addEventListener("fhirPatient", FetchFhirCondition, false );
    let fhirConditionEvent    = new Event("fhirCondition");
    document.addEventListener("fhirCondition", FetchFhirObservation, false );
    let fhirObservationEvent    = new Event("fhirObservation");
    document.addEventListener("fhirObservation", StartApplication, false );
    
    function SetupFhirConnection(event) {
      event.preventDefault();
      event.stopPropagation();
      document.removeEventListener("DOMContentLoaded", SetupFhirConnection, false );
      FHIR.oauth2.ready() 
      .then((client) => {
        EunoChains.fhir.client = client;
        console.log("SetupFhirConnection Successful", JSON.stringify(client.patient));
        document.dispatchEvent(fhirConnectionEvent);
      })
      .catch((err) => {
        console.error("Error: SetupFhirConnection", err);
      });
    }
    function FetchFhirPatient(event) {
      event.preventDefault();
      event.stopPropagation();
      document.removeEventListener("fhirConnection", FetchFhirPatient, false );
      EunoChains.fhir.client.request(`Patient?_id=${EunoChains.fhir.client.patient.id}`)
      .then((data) => {
        EunoChains.fhir.Patient.push(data);
        console.log("FetchFhirPatient Successful", JSON.stringify(data));
        document.dispatchEvent(fhirPatientEvent);
      })
      .catch((err) => {
        console.error("Error: FetchFhirPatient", err);
      });
    }
    function FetchFhirCondition(event) {
      event.preventDefault();
      event.stopPropagation();
      document.removeEventListener("fhirPatient", FetchFhirCondition, false );
      EunoChains.fhir.client.request(`Condition?patient=${EunoChains.fhir.client.patient.id}`)
      .then((data) => {
        EunoChains.fhir.Condition.push(data);
        console.log("FetchFhirCondition Successful", JSON.stringify(data));
        document.dispatchEvent(fhirConditionEvent);
      })
      .catch((err) => {
        console.error("Error: FetchFhirCondition", err);
      });
    }
    function FetchFhirObservation(event) {
      event.preventDefault();
      event.stopPropagation();
      document.removeEventListener("fhirCondition", FetchFhirObservation, false );
      EunoChains.fhir.client.request(`Observation?patient=${EunoChains.fhir.client.patient.id}`)
      .then((data) => {
        EunoChains.fhir.Observation.push(data);
        console.log("FetchFhirObservation Successful", JSON.stringify(data));
        document.dispatchEvent(fhirObservationEvent);
      })
      .catch((err) => {
        console.error("Error: FetchFhirObservation", err);
      });
    }
    
    function StartApplication(event) {
      event.preventDefault();
      event.stopPropagation();
      document.removeEventListener("fhirObservation", StartApplication, false );
      console.log("StartApplication Successful");
      
      return;
    }
    

  </script>
</html>
